### Design Principles

1. **Performance First**: React Server Components, Turbopack builds, optimistic UI updates, streaming SSR
2. **Enterprise UX**: Professional aesthetics with subtle animations that enhance usability without distraction
3. **Modern Architecture**: Server-first rendering with client-side interactivity where needed
4. **Accessibility**: WCAG 2.1 AA compliance with semantic HTML and ARIA labels
5. **Scalability**: Edge-ready architecture, horizontal scaling capability, efficient caching
6. **Security**: Input validation, SQL injection prevention, XSS protection, CSRF tokens
7. **Maintainability**: Clean code, TypeScript for type safety, comprehensive error handling
8. **Developer Experience**: Fast refresh, type-safe APIs, excellent debugging tools

#### 2. Dashboard Components

**AdminDashboard**
- Metric cards with animated counters
- Real-time vehicle status breakdown (pie chart)
- Today's inward/outward activity (bar chart)
- Pending approvals list with quick actions
- Compliance alerts panel

**MetricCard**
- Animated number transitions
- Icon with gradient background
- Trend indicators (up/down arrows)
- Click-through to detailed views

#### 3. Vehicle Management Components

**VehicleList**
- Data table with sorting, filtering, pagination
- Quick status filters (Available, Booked, Maintenance, Blacklisted)
- Search by vehicle ID, type, category
- Bulk actions support
- Row animations on data updates

**VehicleForm**
- Multi-step form for adding/editing vehicles
- Real-time validation with error messages
- File upload for vehicle documents
- Driver assignment dropdown with search
- Smooth step transitions

**VehicleDetailView**
- Tabbed interface (Details, Maintenance History, Booking History, Documents)
- Status badge with color coding
- Compliance status indicators
- Quick action buttons (Edit, Blacklist, Schedule Maintenance)

#### 4. Booking Components

**BookingRequestForm**
- Location autocomplete inputs
- Date/time picker with availability preview
- Vehicle category selector with visual cards
- Driver requirement toggle
- Emergency booking flag
- Estimated distance and time display
- Form validation with inline errors
- Smooth field transitions

**BookingCalendar**
- Month/week/day views
- Color-coded bookings by status
- Drag-and-drop rescheduling (for admins)
- Conflict visualization
- Quick booking details on hover
- Smooth view transitions

**BookingApprovalPanel**
- Pending bookings queue
- Booking detail sidebar
- Approve/Reject/Modify actions
- Vehicle reassignment interface
- Alternate vehicle suggestions
- Mandatory rejection reason modal
- Optimistic UI updates

**BookingHistory**
- Filterable data table
- Status badges
- Download booking slip button
- Expandable row details
- Export to CSV/PDF

#### 5. Driver Management Components

**DriverList**
- Data table with availability status
- License expiry alerts
- Utilization metrics
- Quick edit actions

**DriverForm**
- Personal information fields
- License details with expiry tracking
- Contact information
- Availability status toggle
- Document upload

#### 6. Maintenance Components

**MaintenanceScheduler**
- Calendar view of scheduled maintenance
- Add maintenance modal
- Recurring maintenance setup
- Cost estimation fields

**MaintenanceLog**
- Chronological list of maintenance activities
- Breakdown vs scheduled indicators
- Cost tracking
- Downtime calculation
- Attachment support

#### 7. Tracking Components

**InwardOutwardLog**
- Real-time gate activity feed
- Odometer reading inputs
- Vehicle search/scan
- Trip distance calculation
- Animated list updates

**GateAuditTrail**
- Filterable audit log
- Export functionality
- Vehicle status indicators

#### 8. Compliance Components

**ComplianceAlerts**
- Categorized alerts (PUC, Insurance, License)
- Priority indicators (Critical, Warning, Info)
- Bulk action support
- Dismissal with notes

#### 9. Shared Components

**DataTable**
- Generic reusable table component
- Built-in sorting, filtering, pagination
- Column visibility toggle
- Export functionality
- Responsive design

**Modal**
- Animated entrance/exit
- Backdrop blur effect
- Keyboard navigation support
- Focus trap

**Toast Notifications**
- Success, error, warning, info variants
- Auto-dismiss with progress bar
- Action buttons support
- Stacked notifications

**LoadingStates**
- Skeleton loaders for content
- Spinner for actions
- Progress bars for uploads
- Smooth fade-in when loaded

### Backend API Endpoints

#### Authentication & Authorization

```typescript
// Using NextAuth.js v5 (Auth.js)
POST   /api/auth/signin
POST   /api/auth/signout
GET    /api/auth/session
POST   /api/auth/csrf

// Or using Server Actions (recommended)
// app/actions/auth.ts
'use server'
async function signIn(credentials)
async function signOut()
async function getSession()
```

#### Vehicles

```typescript
// API Routes
GET    /api/vehicles
GET    /api/vehicles/[id]
POST   /api/vehicles
PUT    /api/vehicles/[id]
DELETE /api/vehicles/[id]
PATCH  /api/vehicles/[id]/status
GET    /api/vehicles/[id]/availability
GET    /api/vehicles/[id]/maintenance-history
GET    /api/vehicles/[id]/booking-history

// Or using Server Actions (recommended for mutations)
// app/actions/vehicles.ts
'use server'
async function createVehicle(data)
async function updateVehicle(id, data)
async function deleteVehicle(id)
async function updateVehicleStatus(id, status)
```

#### Bookings

```typescript
// API Routes
GET    /api/bookings
GET    /api/bookings/[id]
POST   /api/bookings
PUT    /api/bookings/[id]
DELETE /api/bookings/[id]
PATCH  /api/bookings/[id]/approve
PATCH  /api/bookings/[id]/reject
PATCH  /api/bookings/[id]/reassign
GET    /api/bookings/[id]/slip
GET    /api/bookings/conflicts
GET    /api/bookings/pending

// Server Actions (recommended)
// app/actions/bookings.ts
'use server'
async function createBooking(data)
async function approveBooking(id, approverId)
async function rejectBooking(id, reason)
async function generateBookingSlip(id)
```

#### Drivers

```typescript
GET    /api/drivers
GET    /api/drivers/[id]
POST   /api/drivers
PUT    /api/drivers/[id]
DELETE /api/drivers/[id]
PATCH  /api/drivers/[id]/availability
GET    /api/drivers/[id]/utilization
```

#### Maintenance

```typescript
GET    /api/maintenance
GET    /api/maintenance/[id]
POST   /api/maintenance
PUT    /api/maintenance/[id]
PATCH  /api/maintenance/[id]/complete
GET    /api/maintenance/scheduled
GET    /api/maintenance/alerts
```

#### Tracking

```typescript
POST   /api/tracking/outward
POST   /api/tracking/inward
GET    /api/tracking/gate-log
GET    /api/tracking/vehicle/[id]/trips
```

#### Compliance

```typescript
GET    /api/compliance/alerts
GET    /api/compliance/expiring
PATCH  /api/compliance/alerts/[id]/dismiss
```

#### Dashboard

```typescript
GET    /api/dashboard/metrics
GET    /api/dashboard/vehicle-status
GET    /api/dashboard/activity
GET    /api/dashboard/pending-approvals
```

#### Audit

```typescript
GET    /api/audit/logs
GET    /api/audit/logs/[entityType]/[entityId]
```

#### Reports

```typescript
GET    /api/reports/usage
GET    /api/reports/fuel-consumption
GET    /api/reports/maintenance-costs
GET    /api/reports/driver-utilization
```

## Data Models

### Database Schema

```typescript
// User Model
interface User {
  id: string;
  email: string;
  passwordHash: string;
  firstName: string;
  lastName: string;
  role: 'ADMIN' | 'SECURITY_ADMIN' | 'USER';
  department: string;
  phone: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}

// Vehicle Model
interface Vehicle {
  id: string;
  vehicleId: string; // User-friendly ID (e.g., "CSL-HV-001")
  category: 'LV' | 'HV';
  type: 'TRUCK' | 'HYDRA' | 'JCB' | 'DUMPER' | 'CAR' | 'BIKE';
  fuelType: 'PETROL' | 'DIESEL' | 'ELECTRIC' | 'CNG';
  capacity: number; // in kg or passengers
  registrationNumber: string;
  make: string;
  model: string;
  year: number;
  status: 'AVAILABLE' | 'BOOKED' | 'MAINTENANCE' | 'BLACKLISTED';
  assignedDriverId: string | null;
  pucExpiryDate: Date;
  insuranceExpiryDate: Date;
  lastServiceDate: Date | null;
  currentOdometer: number;
  createdAt: Date;
  updatedAt: Date;
}

// Driver Model
interface Driver {
  id: string;
  firstName: string;
  lastName: string;
  licenseNumber: string;
  licenseExpiryDate: Date;
  phone: string;
  email: string | null;
  availabilityStatus: 'AVAILABLE' | 'ON_DUTY' | 'ON_LEAVE';
  createdAt: Date;
  updatedAt: Date;
}

// Booking Model
interface Booking {
  id: string;
  bookingId: string; // Format: [ORG]-[VehicleType]-[DDMMYYYY]-[Sequence]
  userId: string;
  vehicleId: string;
  driverId: string | null;
  pickupLocation: string;
  dropLocation: string;
  expectedKm: number;
  purpose: string;
  isEmergency: boolean;
  driverRequired: boolean;
  bookingDate: Date;
  bookingTime: string;
  estimatedDuration: number; // in minutes
  estimatedReturnTime: Date;
  status: 'PENDING' | 'APPROVED' | 'REJECTED' | 'COMPLETED' | 'CANCELLED';
  approvedBy: string | null;
  approvedAt: Date | null;
  rejectionReason: string | null;
  modificationHistory: JSON | null;
  createdAt: Date;
  updatedAt: Date;
}

// Trip Model (Inward/Outward Tracking)
interface Trip {
  id: string;
  bookingId: string;
  vehicleId: string;
  driverId: string | null;
  outwardTime: Date;
  outwardOdometer: number;
  inwardTime: Date | null;
  inwardOdometer: number | null;
  actualDistance: number | null;
  fuelConsumed: number | null;
  fuelCost: number | null;
  status: 'OUT_ON_TRIP' | 'COMPLETED';
  createdAt: Date;
  updatedAt: Date;
}

// Maintenance Model
interface Maintenance {
  id: string;
  vehicleId: string;
  maintenanceType: 'SCHEDULED' | 'BREAKDOWN' | 'INSPECTION';
  description: string;
  scheduledDate: Date;
  completedDate: Date | null;
  estimatedCost: number;
  actualCost: number | null;
  performedBy: string | null;
  status: 'SCHEDULED' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED';
  downtime: number | null; // in hours
  notes: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// Compliance Alert Model
interface ComplianceAlert {
  id: string;
  entityType: 'VEHICLE' | 'DRIVER';
  entityId: string;
  alertType: 'PUC_EXPIRY' | 'INSURANCE_EXPIRY' | 'LICENSE_EXPIRY';
  expiryDate: Date;
  daysUntilExpiry: number;
  severity: 'CRITICAL' | 'WARNING' | 'INFO';
  isDismissed: boolean;
  dismissedBy: string | null;
  dismissedAt: Date | null;
  dismissalNotes: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// Audit Log Model
interface AuditLog {
  id: string;
  userId: string;
  action: string; // e.g., "CREATE_BOOKING", "APPROVE_BOOKING", "UPDATE_VEHICLE"
  entityType: string; // e.g., "BOOKING", "VEHICLE", "DRIVER"
  entityId: string;
  changes: JSON | null; // Old and new values
  ipAddress: string;
  userAgent: string;
  timestamp: Date;
}

// Driver Utilization Model
interface DriverUtilization {
  id: string;
  driverId: string;
  bookingId: string;
  tripId: string;
  date: Date;
  hoursWorked: number;
  kmDriven: number;
  createdAt: Date;
}

// Fuel Record Model
interface FuelRecord {
  id: string;
  vehicleId: string;
  tripId: string | null;
  date: Date;
  quantity: number; // in liters
  cost: number;
  odometerReading: number;
  fuelStation: string | null;
  receiptNumber: string | null;
  createdAt: Date;
}
```

### Database Relationships

```mermaid
erDiagram
    USER ||--o{ BOOKING : creates
    USER ||--o{ AUDIT_LOG : performs
    VEHICLE ||--o{ BOOKING : "assigned to"
    VEHICLE ||--o| DRIVER : "assigned to"
    VEHICLE ||--o{ TRIP : tracks
    VEHICLE ||--o{ MAINTENANCE : requires
    VEHICLE ||--o{ COMPLIANCE_ALERT : generates
    VEHICLE ||--o{ FUEL_RECORD : consumes
    DRIVER ||--o{ BOOKING : "assigned to"
    DRIVER ||--o{ TRIP : operates
    DRIVER ||--o{ DRIVER_UTILIZATION : logs
    DRIVER ||--o{ COMPLIANCE_ALERT : generates
    BOOKING ||--|| TRIP : "results in"
    BOOKING ||--o{ AUDIT_LOG : tracked
    TRIP ||--o{ FUEL_RECORD : records

### Error Categories

**Validation Errors (400 Bad Request)**
- Missing required fields
- Invalid enum values
- Invalid date formats
- Invalid ID formats
- Business rule violations (e.g., booking conflicts)

**Authentication Errors (401 Unauthorized)**
- Invalid credentials
- Expired JWT tokens
- Missing authentication headers

**Authorization Errors (403 Forbidden)**
- Insufficient permissions for requested operation
- Role-based access control violations

**Not Found Errors (404 Not Found)**
- Requested resource does not exist
- Invalid entity IDs

**Conflict Errors (409 Conflict)**
- Booking time conflicts
- Duplicate vehicle IDs
- Concurrent modification conflicts

**Server Errors (500 Internal Server Error)**
- Database connection failures
- Unexpected exceptions
- External service failures

### Error Response Format

All API errors follow a consistent JSON structure:

```typescript
interface ErrorResponse {
  error: {
    code: string;           // Machine-readable error code
    message: string;        // Human-readable error message
    details?: any;          // Additional error context
    timestamp: string;      // ISO 8601 timestamp
    path: string;           // Request path that caused the error
    requestId: string;      // Unique request identifier for tracing
  };
}
```

### Error Handling Strategies

**Frontend Error Handling:**
- Display user-friendly error messages using toast notifications
- Highlight form fields with validation errors
- Provide actionable error messages (e.g., "Vehicle already booked from 2PM-4PM. Try selecting a different time.")
- Implement retry logic for transient failures
- Log errors to monitoring service

**Backend Error Handling:**
- Validate all inputs at API boundary
- Use try-catch blocks for database operations
- Log all errors with context (user ID, request ID, stack trace)
- Return appropriate HTTP status codes
- Never expose internal implementation details in error messages
- Implement circuit breakers for external service calls

**Database Error Handling:**
- Handle unique constraint violations gracefully
- Implement transaction rollback on failures
- Use connection pooling with retry logic
- Handle deadlocks with exponential backoff

## Testing Strategy

### Dual Testing Approach

The system will employ both unit testing and property-based testing to ensure comprehensive coverage:

**Unit Tests:**
- Verify specific examples and edge cases
- Test integration points between components
- Validate error conditions and boundary values
- Test UI component rendering and interactions
- Mock external dependencies

**Property-Based Tests:**
- Verify universal properties across all inputs
- Use randomized input generation to discover edge cases
- Run minimum 100 iterations per property test
- Each property test references its design document property
- Tag format: **Feature: vehicle-fleet-management, Property {number}: {property_text}**

### Property-Based Testing Configuration

**Framework:** fast-check (for TypeScript/JavaScript)

**Configuration:**
```typescript
import fc from 'fast-check';

// Minimum 100 iterations per property test
const testConfig = {
  numRuns: 100,
  verbose: true,
  seed: Date.now() // For reproducibility
};

// Example property test structure
describe('Feature: vehicle-fleet-management, Property 3: Booking ID format compliance', () => {
  it('should generate booking IDs matching the required format', () => {
    fc.assert(
      fc.property(
        fc.record({
          org: fc.constantFrom('CSL', 'ORG'),
          vehicleType: fc.constantFrom('LV', 'HV'),
          date: fc.date(),
          sequence: fc.integer({ min: 1, max: 999 })
        }),
        (input) => {
          const bookingId = generateBookingId(input);
          const regex = /^[A-Z]+-(?:LV|HV)-\d{8}-\d{2}$/;
          expect(bookingId).toMatch(regex);
        }
      ),
      testConfig
    );
  });
});
```

### Test Coverage Requirements

**Backend:**
- Minimum 80% code coverage
- 100% coverage for business logic functions
- All API endpoints tested
- All database queries tested
- All validation logic tested

**Frontend:**
- Minimum 70% code coverage
- All critical user flows tested
- All form validations tested
- All state management logic tested
- Accessibility testing with axe-core

### Testing Layers

**1. Unit Tests**
- Individual functions and methods
- Component rendering (React Testing Library)
- Utility functions
- Validation logic

**2. Integration Tests**
- API endpoint testing (Supertest)
- Database integration
- Service layer interactions
- Authentication and authorization flows

**3. Property-Based Tests**
- Business rule validation across all inputs
- Data integrity properties
- State transition properties
- Calculation accuracy properties

**4. End-to-End Tests**
- Critical user journeys (Playwright)
- Booking workflow
- Vehicle management workflow
- Admin dashboard functionality

### Test Organization

```
/tests
  /unit
    /services
    /utils
    /validators
  /integration
    /api
    /database
  /property
    /booking
    /vehicle
    /driver
    /maintenance
  /e2e
    /booking-flow
    /admin-flow
    /security-admin-flow
```

### Continuous Testing

- Run unit tests on every commit
- Run integration tests on pull requests
- Run property-based tests nightly
- Run E2E tests before deployment
- Monitor test execution time and optimize slow tests

## Performance Considerations

### Frontend Performance

**React Server Components (RSC):**
- Render data-heavy components on the server
- Reduce client-side JavaScript bundle
- Stream UI progressively to the client
- Zero-bundle-size server-only dependencies

**Turbopack Optimization:**
- 5-10x faster Fast Refresh than Webpack
- 2-5x faster production builds
- Incremental compilation
- Optimized tree-shaking

**Code Splitting:**
- Automatic route-based code splitting
- Dynamic imports for heavy components
- Lazy load modals and dialogs
- Split vendor bundles intelligently

**Optimization Techniques:**
- Memoization with React.memo and useMemo
- Virtual scrolling for large lists (react-window or TanStack Virtual)
- Debounce search inputs (300ms)
- Optimize re-renders with useCallback
- Image optimization with Next.js Image component
- Font optimization with next/font

**Caching Strategy:**
- TanStack Query for server state caching
- Cache dashboard metrics for 30 seconds
- Stale-while-revalidate for non-critical data
- Optimistic updates for better UX
- Next.js automatic request deduplication

**Animation Performance:**
- Use CSS transforms for animations (GPU-accelerated)
- Leverage Framer Motion's layout animations
- Limit simultaneous animations to 3-4
- Use will-change CSS property sparingly
- Prefer opacity and transform over other properties

### Backend Performance

**Database Optimization (PostgreSQL 17):**
- Index frequently queried columns (vehicle_id, booking_date, status)
- Use connection pooling (Prisma built-in)
- Implement query result caching with Redis
- Optimize N+1 queries with Prisma includes and select
- Use database views for complex aggregations
- Leverage PostgreSQL 17's streaming I/O for sequential reads
- Utilize improved vacuum performance for maintenance
- Use SQL/JSON functions for complex JSON queries

**Prisma 7 Optimization:**
- 3.4x faster queries (Rust-free architecture)
- 90% smaller bundle size (1.6MB vs 14MB)
- Better edge runtime support
- Efficient query batching
- Connection pooling with PgBouncer

**API Optimization:**
- Implement pagination for list endpoints (default 20 items)
- Use field selection to reduce payload size
- Compress responses with gzip/brotli
- Rate limiting to prevent abuse (100 req/min per user)
- Response caching for read-heavy endpoints
- Edge middleware for auth checks (faster than server-side)

**Caching Strategy:**
- Cache vehicle availability for 1 minute
- Cache dashboard metrics for 30 seconds
- Cache compliance alerts for 5 minutes
- Invalidate cache on relevant mutations
- Use Redis for session storage
- Implement cache warming for frequently accessed data

### Scalability

**Horizontal Scaling:**
- Stateless API design
- Session storage in Redis
- Load balancing with round-robin
- Database read replicas for reporting

**Monitoring:**
- Application performance monitoring (APM)
- Database query performance tracking
- API response time monitoring
- Error rate tracking
- User session analytics

## Security Considerations

### Authentication

- NextAuth.js v5 (Auth.js) with JWT strategy
- JWT tokens with 1-hour expiration
- Refresh tokens with 7-day expiration
- Secure token storage (httpOnly cookies with SameSite=Strict)
- Password hashing with bcrypt (cost factor 12)
- Account lockout after 5 failed login attempts
- CSRF protection built into NextAuth.js
- Session management with database adapter

### Authorization

- Role-based access control (RBAC)
- Middleware for route protection
- Resource-level permissions
- Audit logging for all authorization failures

### Input Validation

- Validate all inputs at API boundary
- Use Zod schemas for type-safe validation
- Sanitize user inputs to prevent XSS
- Parameterized queries to prevent SQL injection
- File upload validation (type, size, content)

### Data Protection

- Encrypt sensitive data at rest
- Use HTTPS for all communications
- Implement CORS policies
- Rate limiting on authentication endpoints
- Regular security audits

### Compliance

- GDPR compliance for user data
- Data retention policies
- Right to deletion implementation
- Audit trail for all data access
- Regular backup and disaster recovery testing

## Deployment Architecture

### Infrastructure

**Development Environment:**
- Local Docker containers
- PostgreSQL database
- Redis cache
- Hot module replacement for frontend

**Staging Environment:**
- Cloud-hosted (AWS/Azure/GCP)
- Separate database instance
- Automated deployments from main branch
- Integration testing suite execution

**Production Environment:**
- High-availability setup
- Load balancer
- Auto-scaling groups
- Database with automated backups
- CDN for static assets
- Monitoring and alerting

### CI/CD Pipeline

1. **Code Commit**
   - Run linters (ESLint, Prettier)
   - Run unit tests
   - Type checking with TypeScript

2. **Pull Request**
   - Run integration tests
   - Run property-based tests
   - Code coverage check
   - Security vulnerability scan

3. **Merge to Main**
   - Build Docker images
   - Deploy to staging
   - Run E2E tests
   - Performance testing

4. **Production Deployment**
   - Blue-green deployment
   - Database migrations
   - Health checks
   - Rollback capability

### Monitoring and Observability

**Application Monitoring:**
- Error tracking (Sentry)
- Performance monitoring (New Relic/Datadog)
- User analytics
- API usage metrics

**Infrastructure Monitoring:**
- Server health checks
- Database performance
- Cache hit rates
- Network latency

**Alerting:**
- Error rate thresholds
- Response time degradation
- Database connection failures
- Disk space warnings
- Security incidents

## Future Enhancements

### Phase 2 Features

1. **Mobile Application**
   - React Native app for drivers
   - Real-time location tracking
   - Push notifications
   - Offline support

2. **Advanced Analytics**
   - Predictive maintenance using ML
   - Route optimization
   - Fuel consumption forecasting
   - Driver performance scoring

3. **Integration Capabilities**
   - GPS tracking integration
   - Fuel card integration
   - Accounting system integration
   - Third-party calendar sync

4. **Enhanced Reporting**
   - Custom report builder
   - Scheduled report delivery
   - Data export in multiple formats
   - Interactive dashboards

5. **Workflow Automation**
   - Automated booking approvals based on rules
   - Automatic vehicle assignment
   - Maintenance scheduling optimization
   - Compliance reminder automation
